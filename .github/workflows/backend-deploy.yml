name: Backend Deployment

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - ".github/workflows/backend-deploy.yml"
  pull_request:
    branches:
      - main
    paths:
      - "backend/**"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  NODE_VERSION: "20.x"

jobs:
  build-and-deploy:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Function App Name from Terraform
        id: get-function-app
        run: |
          cd infrastructure
          terraform init
          FUNCTION_APP_NAME=$(terraform output -raw function_app_name)
          echo "function_app_name=$FUNCTION_APP_NAME" >> $GITHUB_OUTPUT
          echo "Resource Group: rg-jl-jobfitai-dev-weu"
          echo "Function App: $FUNCTION_APP_NAME"

      - name: Install dependencies
        working-directory: ./backend
        run: npm install --production=false

      - name: Build backend
        working-directory: ./backend
        run: npm run build

      - name: Run tests
        working-directory: ./backend
        run: npm test || echo "No tests configured"
        continue-on-error: true

      - name: Prepare deployment package
        working-directory: ./backend
        run: |
          # Remove dev dependencies for production
          npm prune --production

          # Create deployment directory
          mkdir -p ../deploy/backend

          # Copy necessary files
          cp -r dist/* ../deploy/backend/
          cp -r node_modules ../deploy/backend/
          cp package.json ../deploy/backend/
          cp host.json ../deploy/backend/

          echo "Deployment package prepared"

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ steps.get-function-app.outputs.function_app_name }}
          package: "./deploy/backend"

      - name: Verify deployment
        run: |
          FUNCTION_APP_NAME="${{ steps.get-function-app.outputs.function_app_name }}"
          FUNCTION_URL="https://${FUNCTION_APP_NAME}.azurewebsites.net/api/healthCheck"

          echo "Waiting for Function App to be ready..."
          sleep 30

          echo "Testing health check endpoint: $FUNCTION_URL"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FUNCTION_URL" || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Function App is healthy!"
          else
            echo "âš ï¸ Function App returned status: $HTTP_STATUS"
          fi

      - name: Summary
        if: success()
        run: |
          FUNCTION_APP_NAME="${{ steps.get-function-app.outputs.function_app_name }}"
          echo "## Backend Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Function App" >> $GITHUB_STEP_SUMMARY
          echo "- **Name**: $FUNCTION_APP_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: [https://$FUNCTION_APP_NAME.azurewebsites.net](https://$FUNCTION_APP_NAME.azurewebsites.net)" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check**: [/api/healthCheck](https://$FUNCTION_APP_NAME.azurewebsites.net/api/healthCheck)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View in Azure Portal: [Function App](https://portal.azure.com/#@${{ secrets.AZURE_TENANT_ID }}/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-jl-jobfitai-dev-weu/providers/Microsoft.Web/sites/$FUNCTION_APP_NAME)" >> $GITHUB_STEP_SUMMARY
